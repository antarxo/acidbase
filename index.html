<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Προσομοίωση - Εφέ Ripple κατά την Επίδραση της Σταγόνας</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
    }
    canvas {
      display: block;
    }
    .controls {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <script>
    let pipetteImg, breakerImg;
    
    // Η μεταβλητή beakerFill αυξάνεται κατά 3 κάθε φορά
    let beakerFill = 0;
    let dropY;
    let dropActive = false;
    let dropSpeed = 5;
    let showBaseEllipse = false;
    
    let scaleFactorImages = 0.5;
    
    let pipetScaledW, pipetScaledH;
    let breakerScaledW, breakerScaledH;
    
    // Θέσεις εικόνων – στοιχίζονται στη δεξιά πλευρά
    let pipetX, pipetY;
    let breakerX, breakerY;
    
    let initialDropY;
    
    // Ρυθμίσεις για το κόκκινο κουμπί
    let buttonRadius = 15;
    let buttonCenterX, buttonCenterY;
    
    // Πίνακας για τα εφέ ripple
    let rippleEffects = [];
    
    function preload() {
      pipetteImg = loadImage('pipet3.png');
      breakerImg = loadImage('breaker3.png');
    }
    
    function setup() {
      // Υπολογισμός διαστάσεων με scale factor
      pipetScaledW = pipetteImg.width * scaleFactorImages;
      pipetScaledH = pipetteImg.height * scaleFactorImages;
      breakerScaledW = breakerImg.width * scaleFactorImages;
      breakerScaledH = breakerImg.height * scaleFactorImages;
      
      // Ορίζουμε το canvas με πλάτος το μεγαλύτερο από τις δύο εικόνες ώστε να στοιχίζονται στη δεξιά πλευρά
      let canvasWidth = max(pipetScaledW, breakerScaledW);
      let canvasHeight = pipetScaledH + breakerScaledH;
      createCanvas(canvasWidth, canvasHeight).parent("canvas-container");
      
      // Τοποθέτηση εικόνων ώστε η δεξιά τους άκρη να ευθυγραμμίζεται:
      pipetX = canvasWidth - pipetScaledW;
      pipetY = 0;
      
      breakerX = canvasWidth - breakerScaledW;
      breakerY = pipetScaledH;
      
      let pipetBottom = pipetY + pipetScaledH;
      initialDropY = pipetBottom;
      dropY = initialDropY;
      
      // Ορισμός θέσης του κόκκινου κουμπιού (με μετατόπιση αριστερότερα κατά 8 pixels)
      buttonCenterX = pipetX + pipetScaledW - buttonRadius - 5 - 8;
      buttonCenterY = pipetY + buttonRadius + 5 + 15;
      
      createButton("Επαναφορά").parent("controls").mousePressed(resetFill);
      
      textFont('Arial');
      textSize(10);
      textAlign(CENTER, CENTER);
    }
    
    function draw() {
      background(240);
      
      // Ορισμός του "ποτηριού" βάσει της εικόνας breaker
      let containerBottom = breakerY + breakerScaledH - 20;
      // Το μέγιστο ορατό ύψος του υγρού είναι 65% του ύψους του breaker
      let maxLiquidHeight = breakerScaledH * 0.65;
      
      // Το ορατό ύψος του υγρού είναι το ελάχιστο μεταξύ του beakerFill και του maxLiquidHeight
      let drawnLiquidHeight = min(beakerFill, maxLiquidHeight);
      
      // Θέση και πλάτος του υγρού μέσα στο ποτήρι
      let liquidWidth = breakerScaledW * 0.7 - 9;
      let liquidX = (breakerX + (breakerScaledW - liquidWidth) / 2) - 13;
      
      // --- Z-index 70: Κάτω έλλειψη (βάση του υγρού) ---
      if (showBaseEllipse) {
        noStroke();
        fill(234, 234, 234); // #EAEAEA
        ellipseMode(CENTER);
        ellipse(liquidX + liquidWidth / 2, containerBottom, liquidWidth, liquidWidth * 0.3);
      }
      
      // --- Z-index 80: Ορθογώνιο του περιεχομένου (υγρό) ---
      noStroke();
      fill(234, 234, 234);
      rect(liquidX, containerBottom - drawnLiquidHeight, liquidWidth, drawnLiquidHeight);
      
      // --- Z-index 90: Πάνω έλλειψη (γραμμή πάνω του υγρού) ---
      stroke(180);
      strokeWeight(1);
      fill(234, 234, 234);
      ellipseMode(CENTER);
      ellipse(liquidX + liquidWidth / 2, containerBottom - drawnLiquidHeight, liquidWidth, liquidWidth * 0.3);
      noStroke();
      
      // --- Z-index 100: Το ποτήρι (breaker), η pipet, η σταγόνα και το κόκκινο κουμπί ---
      imageMode(CORNER);
      image(breakerImg, breakerX, breakerY, breakerScaledW, breakerScaledH);
      
      // Κίνηση της σταγόνας και έλεγχος για το σημείο παύσης
      if (dropActive) {
        drawDrop();
        dropY += dropSpeed;
        // Η σταγόνα σταματά όταν φτάσει στο ύψος του οριζόντιου άξονα της μετακινούμενης έλλειψης
        let targetY = containerBottom - drawnLiquidHeight; // το κέντρο της πάνω έλλειψης
        if (dropY > targetY) {
          dropActive = false;
          dropY = initialDropY;
          beakerFill += 3;
          showBaseEllipse = true;
          // Δημιουργία εφέ ripple όταν η σταγόνα φτάσει στο targetY
          createRippleEffects(liquidX + liquidWidth / 2, targetY, liquidWidth, liquidWidth * 0.3);
        }
      }
      
      image(pipetteImg, pipetX, pipetY, pipetScaledW, pipetScaledH);
      
      // Εμφάνιση των ripple εφέ
      for (let i = rippleEffects.length - 1; i >= 0; i--) {
        let r = rippleEffects[i];
        noFill();
        stroke(137, 137, 137, r.alpha);
        strokeWeight(2);
        ellipse(r.x, r.y, r.w, r.h);
        // Ενημέρωση με αύξηση διαστάσεων και μείωση αδιαφάνειας
        r.w += r.growthRate;
        r.h += r.growthRate * (r.maxH / r.maxW);
        r.alpha -= 5;
        if (r.w >= r.maxW || r.alpha <= 0) {
          rippleEffects.splice(i, 1);
        }
      }
      
      // Σχεδίαση του κόκκινου κουμπιού με πλήρη σκιά και ετικέτα "Πάτα!"
      push();
      drawingContext.shadowOffsetX = 0;
      drawingContext.shadowOffsetY = 0;
      drawingContext.shadowBlur = 8;
      drawingContext.shadowColor = "rgba(0, 0, 0, 0.5)";
      
      noStroke();
      fill(255, 0, 0);
      ellipse(buttonCenterX, buttonCenterY, buttonRadius * 2, buttonRadius * 2);
      
      drawingContext.shadowBlur = 0;
      fill(255);
      text("Πάτα!", buttonCenterX, buttonCenterY);
      pop();
    }
    
    // Η σταγόνα ξεκινά από σημείο 50 pixels πιο αριστερά από το κέντρο της pipet
    function drawDrop() {
      push();
      fill(137, 137, 137, 217); // Χρώμα #898989 με opacity ~85%
      noStroke();
      ellipse(pipetX + pipetScaledW / 2 - 50, dropY, 10, 15);
      pop();
    }
    
    // Δημιουργεί ripple εφέ (3 ελλείψεις) από το σημείο (x,y)
    // οι παράμετροι maxW, maxH καθορίζουν το τελικό μέγεθος της έλλειψης
    function createRippleEffects(x, y, maxW, maxH) {
      let count = 3;
      for (let i = 0; i < count; i++) {
        rippleEffects.push({
          x: x,
          y: y,
          w: 0,
          h: 0,
          maxW: maxW,
          maxH: maxH,
          growthRate: 2 + i, // μικρή παραλλαγή για κάθε ripple
          alpha: 255
        });
      }
    }
    
    function startDrop() {
      if (!dropActive) {
        dropActive = true;
      }
    }
    
    function resetFill() {
      beakerFill = 0;
      dropY = initialDropY;
      dropActive = false;
      showBaseEllipse = false;
      rippleEffects = [];
    }
    
    // Έλεγχος αν το κλικ έγινε εντός του κόκκινου κουμπιού
    function mousePressed() {
      if (dist(mouseX, mouseY, buttonCenterX, buttonCenterY) < buttonRadius) {
        startDrop();
      }
    }
  </script>
  
  <div id="canvas-container"></div>
  <div id="controls" class="controls"></div>
</body>
</html>
