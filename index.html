<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Ενσωματωμένο Layout - Τελικές Τιμές Pipet & Beaker</title>
  <!-- Εξωτερικές βιβλιοθήκες -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* Βασικές ρυθμίσεις όπως στο αρχικό layout */
    body {
      margin: 0;
      padding: 20px;
      height: calc(100vh - 40px);
      display: grid;
      grid-template-columns: 1fr 480px;
      grid-template-rows: 70% 30%;
      grid-template-areas:
        "diagram table"
        "messages messages";
      gap: 20px;
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      background-color: #f9f9f9;
    }
    .section {
      border: 1px solid #ccc;
      background-color: #fff;
      padding: 10px;
    }
    /* Περιοχές */
    #diagram-container { grid-area: diagram; }
    /* Αντικαθιστούμε το instructions-container με το table-container */
    #table-container {
      grid-area: table;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    /* Στυλ πίνακα 2x2 με συγχωνευμένη πρώτη στήλη */
    #final-values-table {
      width: 100%;
      border-collapse: collapse;
    }
    #final-values-table th, #final-values-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    #final-values-table th { background-color: #eee; }
    /* Κάτω περιοχή: μηνύματα (75%) & κουμπιά (25%) όπως στο αρχικό layout */
    #bottom-container {
      grid-area: messages;
      display: flex;
      gap: 20px;
    }
    #messages-container {
      flex: 3;
    }
    #buttons-container {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Πάνω Αριστερή Περιοχή: Διάγραμμα (AcidBase) -->
  <div id="diagram-container" class="section">
    <canvas id="titrationChart"></canvas>
  </div>
  
  <!-- Πάνω Δεξιά Περιοχή: Πίνακας τελικών τιμών -->
  <div id="table-container" class="section">
    <table id="final-values-table">
      <tr>
        <!-- Συγχωνευμένη πρώτη στήλη -->
        <td rowspan="2" style="min-width:150px;">
          <h3>Τελικές Παράμετροι</h3>
          <!-- Εδώ μπορείτε να τοποθετήσετε επιπλέον πληροφορίες/επιλογές -->
          <p>Παράμετροι ανάλυσης</p>
        </td>
        <th>Τελικά Στοιχεία Pipet</th>
      </tr>
      <tr>
        <td>Τελικά Στοιχεία Beaker</td>
      </tr>
      <tr>
        <!-- Επιπλέον γραμμή με δεδομένα, αν χρειάζεται -->
        <td colspan="2">
          <table style="width:100%; border-collapse:collapse;">
            <tr>
              <th>Pipet (ml)</th>
              <th>Beaker (ml)</th>
            </tr>
            <tr>
              <td id="pipet-info">70 ml</td>
              <td id="beaker-info">70 ml</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>
  
  <!-- Κάτω Περιοχή: Μηνύματα (75%) & Κουμπιά (25%) όπως στο αρχικό layout -->
  <div id="bottom-container">
    <div id="messages-container" class="section">
      <p>Μηνύματα / Οδηγίες</p>
    </div>
    <div id="buttons-container" class="section">
      <button onclick="resetAcidbase()">Επαναφορά AcidBase</button>
      <button onclick="resetGlass()">Επαναφορά Glass</button>
    </div>
  </div>
  
  <!-- Script για το διάγραμμα του AcidBase (Chart.js) -->
  <script>
    let chart;
    const ctx = document.getElementById('titrationChart').getContext('2d');
    
    function calculatepH(type, C_acid, C_base, V_init, pKaInput, step) {
      let volumes = [];
      let pH = [];
      const V_init_L = V_init / 1000;
      const maxVadded = 100;
      const epsilon = 1e-8;
      for (let V_added = 0; V_added <= maxVadded; V_added += step) {
        let totalVolume, n_acid, n_base, currentpH = 0;
        if (type === "strong_base_strong_acid") {
          totalVolume = V_init_L + (V_added / 1000);
          n_base = C_base * V_init_L;
          n_acid = C_acid * (V_added / 1000);
          const excess = n_base - n_acid;
          if (excess > epsilon) {
            let pOH = -Math.log10(excess / totalVolume);
            currentpH = 14 - pOH;
          } else if (excess < -epsilon) {
            currentpH = -Math.log10((n_acid - n_base) / totalVolume);
          } else {
            currentpH = 7;
          }
        } else {
          totalVolume = V_init_L + (V_added / 1000);
          if (type !== "strong_acid_weak_base") {
            n_acid = C_acid * V_init_L;
            n_base = C_base * (V_added / 1000);
          }
          if (type === "strong_acid_strong_base") {
            const excess = n_acid - n_base;
            if (excess > epsilon) {
              currentpH = -Math.log10(excess / totalVolume);
            } else if (excess < -epsilon) {
              currentpH = 14 + Math.log10((-excess) / totalVolume);
            } else {
              currentpH = 7;
            }
          }
          else if (type === "weak_acid_strong_base") {
            if (V_added === 0) {
              currentpH = (pKaInput - Math.log10(C_acid)) / 2;
            }
            else if (n_base < n_acid - epsilon) {
              currentpH = pKaInput + Math.log10(n_base / (n_acid - n_base));
            }
            else if (Math.abs(n_base - n_acid) < epsilon) {
              currentpH = 7 + 0.5 * (pKaInput + Math.log10(n_acid / totalVolume));
            }
            else {
              currentpH = 14 + Math.log10((n_base - n_acid) / totalVolume);
            }
          }
          else if (type === "strong_acid_weak_base") {
            n_base = C_base * V_init_L;
            n_acid = C_acid * (V_added / 1000);
            totalVolume = V_init_L + (V_added / 1000);
            const pKb = pKaInput;
            if (V_added === 0) {
              currentpH = 14 - 0.5 * (pKb - Math.log10(C_base));
            } else if (n_acid < n_base - epsilon) {
              currentpH = 14 - (pKb + Math.log10(n_acid / (n_base - n_acid)));
            } else if (Math.abs(n_acid - n_base) < epsilon) {
              currentpH = 0.5 * ((14 - pKb) - Math.log10(n_base / totalVolume));
            } else {
              currentpH = -Math.log10((n_acid - n_base) / totalVolume);
            }
          }
        }
        volumes.push(V_added);
        pH.push(currentpH);
      }
      return { volumes, pH };
    }
    
    function updateChart() {
      const type = document.getElementById('analysisType') ? document.getElementById('analysisType').value : "strong_acid_strong_base";
      const C_acid = document.getElementById('concAcid') ? parseFloat(document.getElementById('concAcid').value) : 0.1;
      const C_base = document.getElementById('concBase') ? parseFloat(document.getElementById('concBase').value) : 0.1;
      const V_init = document.getElementById('volumeAcid') ? parseFloat(document.getElementById('volumeAcid').value) : 50;
      const pKaInput = document.getElementById('pKa') ? parseFloat(document.getElementById('pKa').value) : 4.76;
      const step = document.getElementById('stepSize') ? parseFloat(document.getElementById('stepSize').value) : 1;
      
      if (document.getElementById('pKa')) {
        if (type === "weak_acid_strong_base" || type === "strong_acid_weak_base") {
          document.getElementById('pKa').disabled = false;
        } else {
          document.getElementById('pKa').disabled = true;
        }
      }
      
      let eqVol = (C_acid * V_init) / C_base;
      const data = calculatepH(type, C_acid, C_base, V_init, pKaInput, step);
      
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.volumes,
          datasets: [{
            label: 'pH',
            data: data.pH,
            borderColor: '#e53935',
            tension: 0.1
          }]
        },
        options: {
          scales: { 
            y: { min: 0, max: 14, title: { display: true, text: 'pH' } },
            x: { title: { display: true, text: 'Όγκος προστιθέμενου αντιδραστηρίου (mL)' } }
          },
          plugins: {
            annotation: {
              annotations: {
                equivalencePoint: {
                  type: 'line',
                  scaleID: 'x',
                  xMin: eqVol,
                  xMax: eqVol,
                  borderColor: '#1e88e5',
                  borderWidth: 2,
                  label: { 
                    content: 'Σημείο Ισοδυναμίας',
                    enabled: true,
                    position: 'end'
                  }
                }
              }
            }
          }
        }
      });
      
      // Ενημέρωση των τελικών στοιχείων στον πίνακα (παράδειγμα)
      document.getElementById('pipet-info').innerText = "70 ml";
      document.getElementById('beaker-info').innerText = "70 ml";
    }
    
    updateChart();
  </script>
  
  <!-- Μικρό script για την επαναφορά (δείγμα) -->
  <script>
    function resetAcidbase() {
      // Επαναφορά τιμών (αν υπάρχουν στοιχεία εισόδου)
      if(document.getElementById('concAcid')) document.getElementById('concAcid').value = 0.1;
      if(document.getElementById('concBase')) document.getElementById('concBase').value = 0.1;
      if(document.getElementById('volumeAcid')) document.getElementById('volumeAcid').value = 50;
      if(document.getElementById('pKa')) document.getElementById('pKa').value = 4.76;
      if(document.getElementById('stepSize')) document.getElementById('stepSize').value = 1;
      updateChart();
    }
    function resetGlass() {
      // Ενδεικτική επαναφορά για το μέρος του γραφικού του glass, εφόσον διατηρούνταν
      // (πλέον τα γραφικά του AcidBase έχουν αφαιρεθεί, οπότε αυτή η λειτουργία μπορεί να απλοποιηθεί)
      console.log("Επαναφορά γραφικών Glass");
    }
  </script>
</body>
</html>
