<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Πραγματική Καμπύλη Ογκομέτρησης</title>
  <!-- Chart.js και το annotation plugin (έκδοση συμβατή) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .chart-container { width: 800px; height: 500px; }
    .param-box { background: #f0f0f0; padding: 15px; border-radius: 8px; }
    input { width: 100px; }
  </style>
</head>
<body>
  <h1>Πραγματική Προσομοίωση Καμπύλης Ογκομέτρησης</h1>
  
  <div class="container">
    <div class="chart-container">
      <canvas id="titrationChart"></canvas>
    </div>

    <div class="param-box">
      <h3>Παράμετροι</h3>
      <label>Τύπος Ανάλυσης:</label>
      <select id="analysisType" onchange="updateChart()">
        <option value="strong_acid_strong_base">Ισχυρό Οξύ + Ισχυρή Βάση</option>
        <option value="weak_acid_strong_base">Ασθενές Οξύ + Ισχυρή Βάση</option>
        <option value="strong_acid_weak_base">Ισχυρό Οξύ + Ασθενή Βάση</option>
      </select>
      <br><br>
      <label>Συγκέντρωση Οξέος (M):</label>
      <input type="number" id="concAcid" value="0.1" step="0.01" onchange="updateChart()">
      <br>
      <label>Συγκέντρωση Βάσης (M):</label>
      <input type="number" id="concBase" value="0.1" step="0.01" onchange="updateChart()">
      <br>
      <label>Όγκος Οξέος (mL):</label>
      <input type="number" id="volumeAcid" value="50" onchange="updateChart()">
      <br>
      <label>pKa:</label>
      <!-- Το pKa χρησιμοποιείται στις περιπτώσεις ασθενές οξύ + ισχυρή βάση και ισχυρό οξύ + ασθενή βάση -->
      <input type="number" id="pKa" value="4.76" step="0.1" onchange="updateChart()">
      <br><br>
      <label>Βήμα προσθήκης (mL):</label>
      <input type="number" id="stepSize" value="1" step="0.1" onchange="updateChart()">
      <br><br>
      <button onclick="resetValues()">Επαναφορά</button>
    </div>
  </div>

  <script>
    let chart;
    const ctx = document.getElementById('titrationChart').getContext('2d');
    // Έλεγχος του annotation plugin
    if (!Chart.registry.plugins.get('annotation')) {
      console.error("Το Chart Annotation plugin δεν φορτώθηκε σωστά.");
    }

    // Συνάρτηση επαναφοράς τιμών
    function resetValues() {
      document.getElementById('concAcid').value = 0.1;
      document.getElementById('concBase').value = 0.1;
      document.getElementById('volumeAcid').value = 50;
      document.getElementById('pKa').value = 4.76;
      document.getElementById('stepSize').value = 1;
      updateChart();
    }

    // Συνάρτηση υπολογισμού pH για τις διάφορες περιπτώσεις
    function calculatepH(type, C_acid, C_base, V_acid, pKa, step) {
      let volumes = [];
      let pH = [];
      const Kw = 1e-14;
      const V_acid_L = V_acid / 1000;
      const maxVbase = 100; // Μέγιστος όγκος βάσης σε mL
      const epsilon = 1e-8; // για σύγκριση τιμών

      for (let V_base = 0; V_base <= maxVbase; V_base += step) {
        const V_base_L = V_base / 1000;
        const totalVolume = V_acid_L + V_base_L;
        const n_acid = C_acid * V_acid_L;
        const n_base = C_base * V_base_L;
        let currentpH = 0;

        if (type === "strong_acid_strong_base") {
          // Ισχυρό οξύ + ισχυρή βάση
          const excess = n_acid - n_base;
          if (excess > epsilon) {
            currentpH = -Math.log10(excess / totalVolume);
          } else if (excess < -epsilon) {
            currentpH = 14 + Math.log10(-excess / totalVolume);
          } else {
            currentpH = 7;
          }
        }
        else if (type === "weak_acid_strong_base") {
          // Ασθενές οξύ + ισχυρή βάση
          if (V_base === 0) {
            // Αρχικό σημείο: pH = (pKa - log(C_acid))/2
            currentpH = (pKa - Math.log10(C_acid)) / 2;
          }
          else if (n_base < n_acid - epsilon) {
            // Πριν την ισοδυναμία (buffer περιοχή) με εξίσωση Henderson–Hasselbalch
            currentpH = pKa + Math.log10(n_base / (n_acid - n_base));
          }
          else if (Math.abs(n_base - n_acid) < epsilon) {
            // Στην ισοδυναμία: pH = -log(A)
            // όπου A = (Kw * totalVolume * n_acid)/Ka, με Ka = 10^(-pKa)
            const Ka = Math.pow(10, -pKa);
            const A = (Kw * totalVolume * n_acid) / Ka;
            currentpH = -Math.log10(A);
          }
          else {
            // Μετά την ισοδυναμία:
            // Αντί για pH = 14 - log(...), χρησιμοποιούμε pH = 14 + log((n_base - n_acid)/totalVolume)
            // έτσι ώστε το log να δίνει αρνητική τιμή για συγκεντρώσεις < 1M
            currentpH = 14 + Math.log10((n_base - n_acid) / totalVolume);
          }
        }
        else if (type === "strong_acid_weak_base") {
          // Ισχυρό οξύ + ασθενή βάση
          if (V_base === 0) {
            // Αρχικό σημείο: pH καθορίζεται από το ισχυρό οξύ
            currentpH = -Math.log10(n_acid / totalVolume);
          }
          else if (n_acid > n_base + epsilon) {
            // Πριν την ισοδυναμία: pH = -log((n_acid - n_base)/totalVolume)
            currentpH = -Math.log10((n_acid - n_base) / totalVolume);
          }
          else if (Math.abs(n_acid - n_base) < epsilon) {
            // Στην ισοδυναμία: pH = 0.5*(pKa - log(n_acid/totalVolume))
            currentpH = 0.5 * (pKa - Math.log10(n_acid / totalVolume));
          }
          else {
            // Μετά την ισοδυναμία (buffer περιοχή): pH = pKa + log((n_base - n_acid)/n_acid)
            currentpH = pKa + Math.log10((n_base - n_acid) / n_acid);
          }
        }

        volumes.push(V_base.toFixed(2));
        pH.push(currentpH);
      }
      return { volumes, pH };
    }

    // Συνάρτηση ενημέρωσης του γραφήματος
    function updateChart() {
      const type = document.getElementById('analysisType').value;
      const C_acid = parseFloat(document.getElementById('concAcid').value);
      const C_base = parseFloat(document.getElementById('concBase').value);
      const V_acid = parseFloat(document.getElementById('volumeAcid').value);
      const pKa = parseFloat(document.getElementById('pKa').value);
      const step = parseFloat(document.getElementById('stepSize').value);

      // Ενεργοποίηση του πεδίου pKa για weak_acid_strong_base και strong_acid_weak_base
      if (type === "weak_acid_strong_base" || type === "strong_acid_weak_base") {
        document.getElementById('pKa').disabled = false;
      } else {
        document.getElementById('pKa').disabled = true;
      }
      
      const data = calculatepH(type, C_acid, C_base, V_acid, pKa, step);
      
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.volumes,
          datasets: [{
            label: 'pH',
            data: data.pH,
            borderColor: '#e53935',
            tension: 0.1
          }]
        },
        options: {
          scales: { 
            y: { min: 0, max: 14, title: { display: true, text: 'pH' } },
            x: { title: { display: true, text: 'Όγκος Βάσης (mL)' } }
          },
          plugins: {
            annotation: {
              annotations: {
                equivalencePoint: {
                  type: 'line',
                  xMin: (C_acid * V_acid / C_base),
                  xMax: (C_acid * V_acid / C_base),
                  borderColor: '#1e88e5',
                  borderWidth: 2,
                  label: { 
                    content: 'Σημείο Ισοδυναμίας',
                    enabled: true,
                    position: 'end'
                  }
                }
              }
            }
          }
        }
      });
    }

    // Αρχική εκτέλεση
    updateChart();
  </script>
</body>
</html>
