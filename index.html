<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Ρεαλιστική Προσομοίωση με p5.js</title>
  <!-- Φόρτωση του p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>
  <script>
    // Μεταβλητές για τις εικόνες
    let pipetteImg, beakerImg;
    
    // Μεταβλητές για το animation και το γέμισμα
    let beakerFill = 0;      // ποσοστό γέμισματος του ποτηριού (0-100)
    let dropY;               // τρέχουσα θέση της σταγόνας
    let dropActive = false;  // αν η σταγόνα κινείται
    let dropSpeed = 5;       // ταχύτητα της σταγόνας
    
    // Διαστάσεις και θέσεις του pipet
    let pipetteX = 100;      
    let pipetteY = 120;
    let pipetteW = 80, pipetteH = 150;
    
    // Διαστάσεις του ποτηριού (beaker)
    let beakerW = 150, beakerH = 250;
    let beakerOffset = 20; // απόσταση μεταξύ pipet και άνω μέρους του ποτηριού
    let beakerY;         // κέντρο του ποτηριού (θα υπολογιστεί)
    
    // Παράμετροι για το σχεδιασμό του υγρού
    let scaleFactor = 10; // κλίμακα για τις διαστάσεις της έλλειψης
    let liquidEllipseWidth = 6.36 * scaleFactor;  // πλάτος έλλειψης υγρού
    let liquidEllipseHeight = 1.93 * scaleFactor;   // ύψος έλλειψης υγρού
    let bottomOffset = 15; // απόσταση από το κάτω μέρος του ποτηριού για την σταθερή έλλειψη
    let topOffset = 20;    // απόσταση από το άνω μέρος του ποτηριού για το ανώτερο όριο του γεμίσματος
    
    // Αρχική θέση για τη σταγόνα (ξεκινά κοντά στο pipet)
    let initialDropY = 100;
    
    function preload() {
      pipetteImg = loadImage('pipet2.png', 
        () => { console.log("pipet2.png loaded successfully"); },
        () => { console.error("Error loading pipet2.png"); }
      );
      
      beakerImg = loadImage('beaker2.png', 
        () => { console.log("beaker2.png loaded successfully"); },
        () => { console.error("Error loading beaker2.png"); }
      );
    }
    
    function setup() {
      createCanvas(400, 600);
      console.log("Setup executed, canvas created");
      
      // Υπολογισμός του κάτω μέρους του pipet και θέσης του ποτηριού
      let pipetteBottom = pipetteY + pipetteH / 2;  // κάτω μέρος του pipet
      // Το πάνω μέρος του ποτηριού θα ξεκινά στο pipetteBottom + beakerOffset,
      // άρα το κέντρο του ποτηριού θα είναι:
      beakerY = (pipetteBottom + beakerOffset) + beakerH / 2;
      
      dropY = initialDropY;
      
      // Δημιουργία κουμπιών αλληλεπίδρασης
      let btnFill = createButton("Προσθήκη Αντιδραστηρίου");
      btnFill.position(10, height + 20);
      btnFill.mousePressed(startDrop);
      
      let btnReset = createButton("Επαναφορά");
      btnReset.position(200, height + 20);
      btnReset.mousePressed(resetFill);
    }
    
    function draw() {
      background(240);
      
      // 1. Σχεδίαση του ποτηριού (beaker) στην καθορισμένη θέση
      imageMode(CENTER);
      if(beakerImg) {
        image(beakerImg, width/2, beakerY, beakerW, beakerH);
      } else {
        fill(255);
        rect(width/2 - beakerW/2, beakerY - beakerH/2, beakerW, beakerH);
        console.error("beakerImg is not loaded");
      }
      
      // 2. Σχεδίαση του υγρού μέσα στο ποτήρι (με βάση το beakerY)
      drawLiquid();
      
      // 3. Σχεδίαση του pipet (που βρίσκεται ψηλότερα από το ποτήρι)
      imageMode(CENTER);
      if(pipetteImg) {
        image(pipetteImg, pipetteX, pipetteY, pipetteW, pipetteH);
      } else {
        fill(200);
        rect(pipetteX - pipetteW/2, pipetteY - pipetteH/2, pipetteW, pipetteH);
        console.error("pipetteImg is not loaded");
      }
      
      // 4. Αν η σταγόνα είναι ενεργή, σχεδιάζουμε και την κίνησή της
      if(dropActive) {
        drawDrop();
        dropY += dropSpeed;
        // Ορίζουμε το όριο του υγρού μέσα στο ποτήρι
        let bottomLiquidY = beakerY + beakerH/2 - bottomOffset;
        if(dropY > bottomLiquidY - liquidEllipseHeight/2) {
          dropActive = false;
          dropY = initialDropY;
          beakerFill = min(beakerFill + 10, 100);
          console.log("Incremented beakerFill to:", beakerFill);
        }
      }
    }
    
    // Σχεδίαση του υγρού μέσα στο ποτήρι:
    // - Το υγρό αποτελείται από ένα ορθογώνιο που έχει πλάτος ίσο με το πλάτος της έλλειψης
    //   και εκτείνεται από τον οριζόντιο άξονα της σταθερής (κάτω) έλλειψης μέχρι τον οριζόντιο άξονα της πάνω μετακινούμενης έλλειψης.
    // - Σχεδιάζουμε μία σταθερή έλλειψη στον πυθμένα και μία πάνω έλλειψη που μεταβάλλεται σύμφωνα με το γεμάτο.
    function drawLiquid() {
      let bottomLiquidY = beakerY + beakerH/2 - bottomOffset;  // οριζόντιος άξονας για την κάτω έλλειψη
      let topLiquidLimit = beakerY - beakerH/2 + topOffset;      // ανώτερο όριο μέσα στο beaker
      let maxLiquidHeight = bottomLiquidY - topLiquidLimit;
      let liquidHeight = map(beakerFill, 0, 100, 0, maxLiquidHeight);
      let topLiquidY = bottomLiquidY - liquidHeight;
      
      noStroke();
      fill(30, 136, 229); // solid χρώμα
      
      // Το ορθογώνιο υγρού με πλάτος ίσο με το πλάτος της έλλειψης:
      rectMode(CORNER);
      rect(width/2 - liquidEllipseWidth/2, topLiquidY, liquidEllipseWidth, liquidHeight);
      
      // Σχεδίαση της πάνω (μετακινούμενης) έλλειψης
      ellipseMode(CENTER);
      ellipse(width/2, topLiquidY, liquidEllipseWidth, liquidEllipseHeight);
      
      // Σχεδίαση της σταθερής, κάτω έλλειψης
      ellipse(width/2, bottomLiquidY, liquidEllipseWidth, liquidEllipseHeight);
    }
    
    // Σχεδίαση της σταγόνας που έρχεται από το pipet
    function drawDrop() {
      push();
      fill(30, 136, 229);
      noStroke();
      ellipse(pipetteX, dropY, 10, 15);
      pop();
    }
    
    // Ξεκινά η κίνηση της σταγόνας
    function startDrop() {
      if (!dropActive) {
        dropActive = true;
        console.log("Drop started");
      }
    }
    
    // Επαναφορά του γεμίσματος και της θέσης της σταγόνας
    function resetFill() {
      beakerFill = 0;
      dropY = initialDropY;
      dropActive = false;
      console.log("Reset executed");
    }
  </script>
</body>
</html>
