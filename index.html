<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Προσομοίωση - Εφέ Bounce & Ripple</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      margin: 100px 0 0 0; /* Ολόκληρη η εφαρμογή μετακινείται 100px προς τα κάτω */
      background-color: #f0f0f0;
      overflow: hidden;
    }
    #canvas-container {
      position: relative;
      margin: auto;
      width: fit-content;
    }
    .slider-label {
      position: absolute;
      font-family: Arial;
      font-size: 12px;
      color: #333;
      background: rgba(255,255,255,0.8);
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 11;
    }
    #controls {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="controls"></div>
  
  <script>
    let pipetteImg, breakerImg;
    
    let beakerFill = 0;
    let dropY;
    let dropActive = false;
    let dropSpeed = 5;
    
    let bouncing = false;
    let bounceVelocity = 0;
    let gravity = 0.5;
    let bounceCount = 0; // Μετρητής αναπήδησης
    
    let scaleFactorImages = 0.5;
    
    let pipetScaledW, pipetScaledH;
    let breakerScaledW, breakerScaledH;
    
    let pipetX, pipetY;
    let breakerX, breakerY;
    
    let initialDropY;
    
    let buttonRadius = 15;
    let buttonCenterX, buttonCenterY;
    
    let rippleEffects = [];
    
    // Sliders για το περιεχόμενο του δοχείου και το pipet
    let sliderInitial, sliderPipet;
    let labelInitial, labelPipet;
    let maxLiquid; // Μέγιστο ύψος υγρού στο δοχείο (σε ml)
    let updateLock = false;
    
    // Ορίζουμε τη μέγιστη τιμή στο δοχείο ως 140 ml
    maxLiquid = 140;
    
    function preload() {
      pipetteImg = loadImage('pipet3.png');
      breakerImg = loadImage('breaker3.png');
    }
    
    function setup() {
      pipetScaledW = pipetteImg.width * scaleFactorImages;
      pipetScaledH = pipetteImg.height * scaleFactorImages;
      breakerScaledW = breakerImg.width * scaleFactorImages;
      breakerScaledH = breakerImg.height * scaleFactorImages;
      
      let canvasWidth = max(pipetScaledW, breakerScaledW);
      let canvasHeight = pipetScaledH + breakerScaledH;
      let cnv = createCanvas(canvasWidth, canvasHeight);
      cnv.parent("canvas-container");
      
      pipetX = canvasWidth - pipetScaledW;
      pipetY = 0;
      
      breakerX = canvasWidth - breakerScaledW;
      breakerY = pipetScaledH;
      
      let pipetBottom = pipetY + pipetScaledH;
      initialDropY = pipetBottom;
      dropY = initialDropY;
      
      buttonCenterX = pipetX + pipetScaledW - buttonRadius - 5 - 8;
      buttonCenterY = pipetY + buttonRadius + 5 + 15;
      
      createButton("Επαναφορά").parent("controls").mousePressed(resetFill);
      
      textFont('Arial');
      textSize(10);
      textAlign(CENTER, CENTER);
      
      // Αρχικές τιμές: 70 και 70 για τους επιλογείς (άθροισμα 140)
      sliderInitial = createSlider(0, maxLiquid, 70, 1);
      sliderPipet = createSlider(0, maxLiquid, 70, 1);
      
      // Τοποθέτηση του slider του δοχείου (sliderInitial)
      sliderInitial.parent("canvas-container");
      sliderInitial.style('position','absolute');
      sliderInitial.style('z-index','10');
      sliderInitial.style('transform', 'rotate(-90deg)');
      // Μετακίνηση: 80 px αριστερότερα και 80 px προς τα πάνω
      sliderInitial.style('left', (breakerX + breakerScaledW + 20 - 80) + 'px');
      sliderInitial.style('top', (breakerY + breakerScaledH - 40 - 80) + 'px');
      
      // Τοποθέτηση του slider του pipet (sliderPipet)
      sliderPipet.parent("canvas-container");
      sliderPipet.style('position','absolute');
      sliderPipet.style('z-index','10');
      sliderPipet.style('transform', 'rotate(-90deg)');
      // Μετακίνηση: 60 px αριστερότερα και 80 px προς τα Κάτω
      sliderPipet.style('left', (pipetX - 50 - 60) + 'px');
      sliderPipet.style('top', (pipetY + 10 + 80) + 'px');
      
      // Δημιουργία ετικετών για τους sliders στο πάνω άκρο κάθε slider
      labelInitial = createDiv(int(sliderInitial.value()) + " ml");
      labelInitial.parent("canvas-container");
      labelInitial.class("slider-label");
      labelInitial.position(breakerX + breakerScaledW + 20 - 80, breakerY + breakerScaledH - 40 - 80 - 20);
      
      labelPipet = createDiv(int(sliderPipet.value()) + " ml");
      labelPipet.parent("canvas-container");
      labelPipet.class("slider-label");
      labelPipet.position(pipetX - 50 - 60, pipetY + 10 + 80 - 20);
      
      // Ενημέρωση των sliders ώστε το άθροισμά τους να παραμένει σταθερό
      sliderInitial.input(function() {
        if (!updateLock) {
          updateLock = true;
          let initialVal = int(sliderInitial.value());
          sliderPipet.value(maxLiquid - initialVal);
          beakerFill = initialVal;
          labelInitial.html(initialVal + " ml");
          labelPipet.html(int(sliderPipet.value()) + " ml");
          updateLock = false;
        }
      });
      
      sliderPipet.input(function() {
        if (!updateLock) {
          updateLock = true;
          let pipetVal = int(sliderPipet.value());
          sliderInitial.value(maxLiquid - pipetVal);
          labelPipet.html(pipetVal + " ml");
          labelInitial.html(int(sliderInitial.value()) + " ml");
          updateLock = false;
        }
      });
      
      beakerFill = int(sliderInitial.value());
    }
    
    function draw() {
      background(240);
      
      let containerBottom = breakerY + breakerScaledH - 20;
      // Το ύψος του υγρού σχεδιάζεται ως το beakerFill (μέχρι το συνολικό target, το άθροισμα των τιμών των sliders)
      let totalTarget = int(sliderInitial.value()) + int(sliderPipet.value());
      let drawnLiquidHeight = min(beakerFill, totalTarget);
      
      let liquidWidth = breakerScaledW * 0.7 - 9;
      let liquidX = (breakerX + (breakerScaledW - liquidWidth) / 2) - 13;
      
      // Σχεδιάζουμε πρώτα την κάτω σταθερή έλλειψη (βάση του δοχείου)
      noStroke();
      fill(234, 234, 234);
      ellipseMode(CENTER);
      ellipse(liquidX + liquidWidth / 2, containerBottom, liquidWidth, liquidWidth * 0.3);
      
      // Σχεδιάζουμε στη συνέχεια το περιεχόμενο (υγρό) του δοχείου πάνω από την έλλειψη
      noStroke();
      fill(234, 234, 234);
      rect(liquidX, containerBottom - drawnLiquidHeight, liquidWidth, drawnLiquidHeight);
      
      // Σχεδιάζουμε την επάνω έλλειψη του υγρού για ομαλή μετάβαση
      stroke(180);
      strokeWeight(1);
      fill(234, 234, 234);
      ellipseMode(CENTER);
      ellipse(liquidX + liquidWidth / 2, containerBottom - drawnLiquidHeight, liquidWidth, liquidWidth * 0.3);
      noStroke();
      
      imageMode(CORNER);
      image(breakerImg, breakerX, breakerY, breakerScaledW, breakerScaledH);
      
      let targetY = containerBottom - drawnLiquidHeight;
      
      if (dropActive) {
        if (!bouncing) {
          dropY += dropSpeed;
          if (dropY >= targetY) {
            createRippleEffects(liquidX + liquidWidth / 2, targetY, liquidWidth, liquidWidth * 0.3);
            bouncing = true;
            bounceVelocity = -2; // Πρώτη αναπήδηση με μειωμένο ύψος
            bounceCount = 1;
          }
        } else {
          dropY += bounceVelocity;
          bounceVelocity += gravity;
          if (dropY >= targetY && bounceVelocity > 0) {
            if (bounceCount === 1) {
              // Δεύτερη αναπήδηση
              createRippleEffects(liquidX + liquidWidth / 2, targetY, liquidWidth, liquidWidth * 0.3);
              bounceVelocity = -2;
              bounceCount++;
            } else {
              // Ολοκλήρωση μετά τη δεύτερη αναπήδηση
              dropActive = false;
              bouncing = false;
              dropY = initialDropY;
              if (beakerFill < totalTarget) {
                beakerFill += 3;
              }
              // Μείωση του slider του pipet κατά 5 ml
              let newPipet = max(int(sliderPipet.value()) - 5, 0);
              sliderPipet.value(newPipet);
              sliderInitial.value(maxLiquid - newPipet);
              labelPipet.html(newPipet + " ml");
              labelInitial.html(int(sliderInitial.value()) + " ml");
            }
          }
        }
        drawDrop();
      }
      
      image(pipetteImg, pipetX, pipetY, pipetScaledW, pipetScaledH);
      
      // Σχεδίαση των ripple effects
      for (let i = rippleEffects.length - 1; i >= 0; i--) {
        let r = rippleEffects[i];
        noFill();
        stroke(137, 137, 137, r.alpha);
        strokeWeight(2);
        ellipse(r.x, r.y, r.w, r.h);
        r.w += r.growthRate;
        r.h += r.growthRate * (r.maxH / r.maxW);
        r.alpha -= 5;
        if (r.w >= r.maxW || r.alpha <= 0) {
          rippleEffects.splice(i, 1);
        }
      }
      
      // Σχεδίαση του "Πάτα!" κουμπιού (πάντα κόκκινο)
      push();
      drawingContext.shadowOffsetX = 0;
      drawingContext.shadowOffsetY = 0;
      drawingContext.shadowBlur = 8;
      drawingContext.shadowColor = "rgba(0, 0, 0, 0.5)";
      noStroke();
      fill(255, 0, 0);
      ellipse(buttonCenterX, buttonCenterY, buttonRadius * 2, buttonRadius * 2);
      drawingContext.shadowBlur = 0;
      fill(255);
      text("Πάτα!", buttonCenterX, buttonCenterY);
      pop();
    }
    
    function drawDrop() {
      let dropX = pipetX + pipetScaledW / 2 - 50;
      push();
      fill(137, 137, 217, 217);
      noStroke();
      ellipse(dropX, dropY, 10, 15);
      pop();
    }
    
    function createRippleEffects(x, y, maxW, maxH) {
      let count = 3;
      for (let i = 0; i < count; i++) {
        rippleEffects.push({
          x: x,
          y: y,
          w: 0,
          h: 0,
          maxW: maxW,
          maxH: maxH,
          growthRate: 2 + i,
          alpha: 255
        });
      }
    }
    
    function startDrop() {
      let totalTarget = int(sliderInitial.value()) + int(sliderPipet.value());
      if (beakerFill >= totalTarget) return;
      if (!dropActive) {
        dropActive = true;
        bouncing = false;
        bounceVelocity = 0;
      }
    }
    
    function resetFill() {
      beakerFill = int(sliderInitial.value());
      dropY = initialDropY;
      dropActive = false;
      bouncing = false;
      bounceVelocity = 0;
      bounceCount = 0;
      rippleEffects = [];
    }
    
    function mousePressed() {
      let totalTarget = int(sliderInitial.value()) + int(sliderPipet.value());
      if (beakerFill >= totalTarget) return;
      if (dist(mouseX, mouseY, buttonCenterX, buttonCenterY) < buttonRadius) {
        startDrop();
      }
    }
  </script>
</body>
</html>
